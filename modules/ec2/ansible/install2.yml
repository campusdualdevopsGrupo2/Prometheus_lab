- name: Configure Elasticsearch Nodes
  hosts: all
  become: yes
  vars:
    docker_compose_file: /home/ubuntu/docker-compose.yml.j2   # Ruta de destino para el archivo docker-compose.yml
    json_ip_name: /home/ubuntu/seed_hosts.json

  tasks:
  
    - name: Copiar carpeta completa de forma recursiva
      ansible.builtin.copy:
        src: ./config/prometheus.yml # Carpeta en tu m√°quina
        dest: /mnt/efs/prometheus/config/prometheus.yml           # Carpeta en el servidor
        mode: "0644"
    - name: Copy Requirements
      copy:
        src:  ../../../app/requirements.txt
        dest: /home/ubuntu/requirements.txt
        mode: '0644'

    - name: Copy src
      copy:
        src:  ../../../app/src/
        dest: /home/ubuntu/src/
        mode: '0644'

    # Tarea 1: Copia el Dockerfile al host
    - name: Copy Dockerfile
      copy:
        src: ./Dockerfile.prometheus
        dest: /home/ubuntu/Dockerfile.prometheus
        mode: '0644'

    # Tarea 2: Obtiene la IP privada del host actual
    - name: Get private IP of the current host
      set_fact:
        PRIVATE_IP: "{{ ansible_default_ipv4.address }}"

    # Tarea 3: Genera el archivo docker-compose.yml a partir de la plantilla
    - name: Generate docker-compose.yml from template
      copy:
        src: ./docker-compose.yml    # Ruta de la plantilla
        dest: /home/ubuntu/docker-compose.yml    # Ruta de destino
        mode: '0644'

    # Tarea 4: Detiene Elasticsearch usando Docker Compose
    - name: Start Elasticsearch with Docker Compose
      command: docker compose down
      args:
        chdir: /home/ubuntu

    # Tarea 5: Inicia Elasticsearch en segundo plano utilizando Docker Compose
    - name: Start Elasticsearch with Docker Compose
      command: docker compose up -d
      args:
        chdir: /home/ubuntu
